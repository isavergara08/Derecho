<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Malla Derecho – Editable</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Poppins',sans-serif;
  background:#f7efff;
  padding:30px;
}

.header{text-align:center;margin-bottom:30px;}
.progress-container{width:60%;margin:10px auto;height:16px;background:#e5d3ff;border-radius:999px;}
.progress-bar{height:100%;background:#8238FF;width:0%;border-radius:999px;}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
  gap:25px;
}

.card{
  background:#faf4ff;
  border:2px solid #d9b8ff;
  border-radius:22px;
  padding:15px;
}

.sem-title{
  background:#8238FF;
  color:white;
  padding:10px;
  border-radius:14px;
  text-align:center;
  font-weight:600;
}

.info-line{text-align:center;margin:10px 0;}

.subject{
  background:#f1e6ff;
  padding:10px;
  border-radius:16px;
  margin-bottom:8px;
  cursor:grab;
}

.subject.checked{
  background:#dcc3ff;
  text-decoration:line-through;
  color:#6f4aa8;
}

.subject.dragging{opacity:.4;}
</style>
</head>

<body>

<div class="header">
  <h1>Malla Derecho</h1>
  <p>Créditos aprobados: <span id="approvedCredits">0</span> / 183</p>
  <div class="progress-container">
    <div id="progress" class="progress-bar"></div>
  </div>
</div>

<div id="grid" class="grid"></div>

<script>
const TOTAL = 183;

let semesters = JSON.parse(localStorage.getItem('malla')) || [
 {name:'6° semestre',subjects:[
  {name:'Protección Laboral',credits:3,done:false},
  {name:'Pruebas',credits:3,done:false},
  {name:'Contratos',credits:5,done:false},
  {name:'Penal Especial',credits:3,done:false},
  {name:'Argumentación Civil',credits:3,done:false},
  {name:'Facultativa 1',credits:3,done:false},
  {name:'CBU 7',credits:2,done:false}
 ]}
];

let dragged=null;

function render(){
 const grid=document.getElementById('grid');
 grid.innerHTML='';
 let approved=0;

 semesters.forEach((sem,si)=>{
  const card=document.createElement('div');
  card.className='card';

  const credits=sem.subjects.reduce((a,b)=>a+b.credits,0);
  card.innerHTML=`<div class="sem-title">${sem.name}</div>
                  <div class="info-line">${credits} créditos</div>`;

  const list=document.createElement('div');

  list.ondragover=e=>{
    e.preventDefault();
    const after=getAfter(list,e.clientY);
    if(after==null) list.appendChild(dragged);
    else list.insertBefore(dragged,after);
  };

  list.ondrop=()=>{
    save();
    render();
  };

  sem.subjects.forEach((sub,ci)=>{
    if(sub.done) approved+=sub.credits;

    const div=document.createElement('div');
    div.className='subject'+(sub.done?' checked':'');
    div.textContent=`${sub.name} (${sub.credits})`;
    div.draggable=true;

    div.onclick=()=>{
      sub.done=!sub.done;
      save(); render();
    };

    div.ondragstart=()=>{
      dragged=div;
      dragged.dataset.fromSem=si;
      dragged.dataset.index=ci;
      div.classList.add('dragging');
    };

    div.ondragend=()=>{
      div.classList.remove('dragging');
      const from=dragged.dataset.fromSem;
      const idx=dragged.dataset.index;
      const to=si;
      const newIdx=[...list.children].indexOf(div);

      const moved=semesters[from].subjects.splice(idx,1)[0];
      semesters[to].subjects.splice(newIdx,0,moved);
      save();
      render();
    };

    list.appendChild(div);
  });

  card.appendChild(list);
  grid.appendChild(card);
 });

 document.getElementById('approvedCredits').textContent=approved;
 document.getElementById('progress').style.width=(approved/TOTAL*100)+'%';
}

function getAfter(container,y){
 return [...container.children].find(el=>{
  const box=el.getBoundingClientRect();
  return y < box.top + box.height/2;
 });
}

function save(){
 localStorage.setItem('malla',JSON.stringify(semesters));
}

render();
</script>

</body>
</html>
